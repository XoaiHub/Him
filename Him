if not getgenv().EnableTeleport then return end
repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local zonesFolder = workspace:WaitForChild("PartyZones", 10)

local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart", 5)
end

-- Đếm số người trong Zone
local function getPlayerCountInZone(zoneName)
    local zone = zonesFolder:FindFirstChild(zoneName)
    if not zone then return math.huge end
    local hitbox = zone:FindFirstChild("Hitbox")
    if not hitbox then return math.huge end

    local count = 0
    for _, p in pairs(Players:GetPlayers()) do
        local char = p.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        if hrp and (hrp.Position - hitbox.Position).Magnitude <= 10 then
            count += 1
        end
    end
    return count
end

-- Kiểm tra nếu player đã ở đúng Zone
local function isInZone(zoneName)
    local zone = zonesFolder:FindFirstChild(zoneName)
    if not zone then return false end
    local hitbox = zone:FindFirstChild("Hitbox")
    if not hitbox then return false end

    local hrp = getHRP()
    return (hrp.Position - hitbox.Position).Magnitude <= 10
end

-- Vòng lặp chính
while true do
    local currentZone = getgenv().TeleportZoneName
    local playerInCurrent = getPlayerCountInZone(currentZone)
    local maxInCurrent = getgenv().TargetPlayersPerZone[currentZone] or 1

    -- Nếu đang ở đúng Zone và chưa đủ người → không làm gì cả
    if isInZone(currentZone) and playerInCurrent < maxInCurrent then
        -- Đủ điều kiện rồi, không cần Teleport nữa
    else
        -- Tìm zone khác có chỗ trống
        for zoneName, maxPlayers in pairs(getgenv().TargetPlayersPerZone) do
            local count = getPlayerCountInZone(zoneName)
            if count < maxPlayers then
                local zone = zonesFolder:FindFirstChild(zoneName)
                if zone then
                    local hitbox = zone:FindFirstChild("Hitbox")
                    if hitbox then
                        local pos = hitbox.Position + Vector3.new(0, getgenv().YOffset or 5, 0)
                        getHRP().CFrame = CFrame.new(pos)
                        getgenv().TeleportZoneName = zoneName -- cập nhật zone hiện tại
                        break
                    end
                end
            end
        end
    end

    task.wait(getgenv().TeleportInterval or 5)
end
