--================= CONFIG =================
local Config = {
    FARM_PLACE_ID    = 126509999114328,
    ChestName        = "Stronghold Diamond Chest",
    ChestTimeout     = 10,
    WaitDiamondTime  = 20,
    UIScanInterval   = 0.2,
    HopLoopDelay     = 2,
    RegionFilter     = {"singapore","tokyo","us-east"},
    RegionFilterEnabled = false
}

--================= SERVICES =================
local Players = game:GetService("Players")
local lp      = Players.LocalPlayer
local RS      = game:GetService("ReplicatedStorage")
local TS      = game:GetService("TeleportService")
local HS      = game:GetService("HttpService")
local SG      = game:GetService("StarterGui")

local Remote  = RS:WaitForChild("RemoteEvents"):WaitForChild("RequestTakeDiamonds")
local Interface = lp:WaitForChild("PlayerGui"):WaitForChild("Interface")
local DiamondCount = Interface:WaitForChild("DiamondCount"):WaitForChild("Count")

--================= STATE =================
local PlaceID = game.PlaceId
local AllIDs, cursor = {}, ""
local isTeleporting, shouldHop, requestHopNow = false, true, false
local ui = {}

--================= UTILS =================
local function notify(t)
    pcall(function() SG:SetCore("SendNotification", {Title="Notification", Text=t, Duration=3}) end)
end

local function rainbowStroke(stroke)
    task.spawn(function()
        while task.wait() do
            for hue=0,1,0.01 do
                stroke.Color = Color3.fromHSV(hue,1,1)
                task.wait(0.02)
            end
        end
    end)
end

--================= UI =================
do
    if game.CoreGui:FindFirstChild("DiamondFarmUI") then game.CoreGui.DiamondFarmUI:Destroy() end
    local a = Instance.new("ScreenGui", game.CoreGui)
    a.Name, a.ResetOnSpawn = "DiamondFarmUI", false
    ui.root = a

    local frame = Instance.new("Frame", a)
    frame.Size, frame.Position = UDim2.new(0,220,0,100), UDim2.new(0,80,0,100)
    frame.BackgroundColor3, frame.Active, frame.Draggable = Color3.fromRGB(35,35,35), true, true
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0,8)
    local stroke = Instance.new("UIStroke", frame) stroke.Thickness=1.5 rainbowStroke(stroke)

    local title = Instance.new("TextLabel", frame)
    title.Size, title.Text, title.TextColor3, title.Font, title.TextSize = UDim2.new(1,0,0,28), "Kaitun 99 Night", Color3.new(1,1,1), Enum.Font.GothamBold, 14
    title.BackgroundTransparency=1

    local status = Instance.new("TextLabel", frame)
    status.Size, status.Position, status.TextColor3, status.TextSize, status.Font = UDim2.new(1,-20,0,30), UDim2.new(0,10,0,36), Color3.new(1,1,1), 14, Enum.Font.GothamBold
    status.Text, status.BackgroundColor3, status.BorderSizePixel = "Status: init...", Color3.fromRGB(0,0,0), 0
    Instance.new("UICorner", status).CornerRadius = UDim.new(0,6)
    ui.status = status

    local diamonds = Instance.new("TextLabel", frame)
    diamonds.Size, diamonds.Position, diamonds.TextColor3, diamonds.TextSize, diamonds.Font = UDim2.new(1,-20,0,24), UDim2.new(0,10,0,70), Color3.new(1,1,1), 14, Enum.Font.Gotham
    diamonds.Text, diamonds.BackgroundTransparency = "Diamonds: ...", 1
    ui.diamonds = diamonds

    task.spawn(function()
        while task.wait(Config.UIScanInterval) do
            pcall(function() ui.diamonds.Text="Diamonds: "..(DiamondCount and DiamondCount.Text or "?") end)
        end
    end)
end

local function setStatus(t) if ui.status then ui.status.Text = "Status: "..t end end

--================= TELEPORTER AUTO (lobby) =================
local function tpTo(cf) if lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") then lp.Character:SetPrimaryPartCFrame(cf) end end
local function checkTeleporter(obj)
    local g=obj:FindFirstChild("BillboardHolder")
    if g and g:FindFirstChild("BillboardGui") and g.BillboardGui:FindFirstChild("Players") then
        local t=g.BillboardGui.Players.Text local x,y=t:match("(%d+)/(%d+)") x,y=tonumber(x),tonumber(y)
        if x and y and x>=2 then
            local enter=obj:FindFirstChildWhichIsA("BasePart")
            if enter and lp.Character and lp.Character:FindFirstChild("Humanoid") then
                local hrp=lp.Character:FindFirstChild("HumanoidRootPart")
                if hrp then
                    lp.Character.Humanoid:MoveTo(enter.Position)
                    if(hrp.Position-enter.Position).Magnitude>10 then tpTo(enter.CFrame+Vector3.new(0,3,0)) end
                end
            end
        end
    end
end
task.spawn(function()
    while task.wait(0.5) do
        if game.PlaceId~=Config.FARM_PLACE_ID then
            for _,obj in ipairs(workspace:GetChildren()) do
                if obj:IsA("Model") and(obj.Name=="Teleporter1"or obj.Name=="Teleporter2"or obj.Name=="Teleporter3") then
                    checkTeleporter(obj)
                end
            end
        end
    end
end)

--================= SERVER HOP =================
local function hasValue(t,v) for _,x in ipairs(t) do if x==v then return true end end return false end
local function fetchPage(cur)
    local url=("https://games.roblox.com/v1/games/%s/servers/Public?sortOrder=Desc&excludeFullGames=true&limit=100%s"):format(PlaceID,cur~="" and("&cursor="..cur) or"")
    local ok,data=pcall(function() return HS:JSONDecode(game:HttpGet(url)) end)
    return ok and data or nil
end
local function regionMatch(entry)
    if not Config.RegionFilterEnabled then return true end
    local raw=tostring(entry.ping or entry.region or ""):lower()
    for _,key in ipairs(Config.RegionFilter) do if raw:find(key:lower()) then return true end end
    return false
end
local function tryTeleport()
    local page=fetchPage(cursor) if not page or not page.data then return false end
    cursor=page.nextPageCursor or ""
    for _,v in ipairs(page.data) do
        if tonumber(v.playing)<tonumber(v.maxPlayers) then
            local sid=tostring(v.id)
            if not hasValue(AllIDs,sid) and regionMatch(v) then
                table.insert(AllIDs,sid)
                setStatus(("Teleport -> %s (%s/%s)"):format(sid,v.playing,v.maxPlayers))
                isTeleporting=true
                pcall(function() TS:TeleportToPlaceInstance(PlaceID,sid,lp) end)
                task.delay(5,function() isTeleporting=false end)
                return true
            end
        end
    end
    return false
end
task.spawn(function()
    while shouldHop and task.wait(Config.HopLoopDelay) do
        if isTeleporting then continue end
        if requestHopNow then
            cursor="" if tryTeleport() then requestHopNow=false continue end
        end
        tryTeleport()
    end
end)

--================= CHEST/DIAMOND =================
local function waitCharacter() repeat task.wait() until lp.Character and lp.Character:FindFirstChild("HumanoidRootPart") end
local function findChest()
    local items=workspace:FindFirstChild("Items") if not items then return nil end
    return items:FindFirstChild(Config.ChestName)
end
local function pressPrompt(prompt,tout)
    local t0=tick()
    while prompt and prompt.Parent and tick()-t0<tout do pcall(function() fireproximityprompt(prompt) end) task.wait(0.3) end
    return prompt and not prompt.Parent
end
local function getPrompt(chest)
    local main=chest:FindFirstChild("Main") if not main then return nil end
    local att=main:FindFirstChild("ProximityAttachment") if not att then return nil end
    return att:FindFirstChildWhichIsA("ProximityPrompt",true)
end
local function waitDiamonds(tout)
    local t0=tick()
    while tick()-t0<tout do if workspace:FindFirstChild("Diamond",true) then return true end task.wait(0.2) end
    return false
end
local function collectDiamonds()
    local c=0
    for _,v in ipairs(workspace:GetDescendants()) do
        if v:IsA("Model") and v.Name=="Diamond" then pcall(function() Remote:FireServer(v) c+=1 end) end
    end
    return c
end

--================= MAIN LOOP =================
task.spawn(function()
    while true do
        if game.PlaceId~=Config.FARM_PLACE_ID then task.wait(2) continue end
        setStatus("Tìm chest...")
        waitCharacter()
        local chest=findChest()
        if not chest then setStatus("Không có chest -> hop") requestHopNow=true task.wait(2) continue end

        local hrp=lp.Character and lp.Character:FindFirstChild("HumanoidRootPart")
        if hrp then lp.Character:PivotTo(CFrame.new(chest:GetPivot().Position+Vector3.new(0,3,0))) end

        setStatus("Bấm prompt...")
        local prompt=getPrompt(chest) if prompt then pressPrompt(prompt,Config.ChestTimeout) end

        if prompt and prompt.Parent then setStatus("Stronghold đang chạy -> hop") requestHopNow=true task.wait(2) continue end

        setStatus("Chờ diamond...")
        if not waitDiamonds(Config.WaitDiamondTime) then setStatus("Không spawn diamond -> hop") requestHopNow=true task.wait(2) continue end

        setStatus("Nhặt diamond...")
        local got=collectDiamonds() task.wait(0.5) got+=collectDiamonds()
        notify(("Đã nhặt %d diamond."):format(got))

        setStatus("Xong, hop server...")
        requestHopNow=true
        for i=1,50 do if isTeleporting then break end task.wait(0.1) end
    end
end)
