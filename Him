if not getgenv().EnableTeleport then return end
repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Lấy HRP
local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

-- Đếm số người trong Zone
local function getPlayerCountInZone(zoneName)
    local zone = workspace:WaitForChild("PartyZones", 10):FindFirstChild(zoneName)
    if not zone then return 0 end
    local hitbox = zone:FindFirstChild("Hitbox")
    if not hitbox then return 0 end

    local count = 0
    for _, p in pairs(Players:GetPlayers()) do
        local char = p.Character
        if char and char:FindFirstChild("HumanoidRootPart") then
            local dist = (char.HumanoidRootPart.Position - hitbox.Position).Magnitude
            if dist < 15 then
                count += 1
            end
        end
    end
    return count
end

-- Teleport đến zone
local function teleportTo(zoneName)
    local zone = workspace:WaitForChild("PartyZones", 10):FindFirstChild(zoneName)
    if not zone then return end
    local hitbox = zone:FindFirstChild("Hitbox")
    if not hitbox then return end

    local hrp = getHRP()
    if hrp then
        local yOffset = getgenv().YOffset or 5
        hrp.CFrame = CFrame.new(hitbox.Position + Vector3.new(0, yOffset, 0))
        print("[Teleported to]:", zoneName)
    end
end

-- Tạo party
local function createParty(mode)
    local args = {{
        isPrivate = true,
        maxMembers = 1,
        trainId = "default",
        gameMode = mode
    }}
    game:GetService("ReplicatedStorage"):WaitForChild("Shared"):WaitForChild("Network")
        :WaitForChild("RemoteEvent"):WaitForChild("CreateParty"):FireServer(unpack(args))
end

-- Auto hệ thống
task.spawn(function()
    local zoneList = {}
    for zoneName, _ in pairs(getgenv().TargetPlayersPerZone) do
        table.insert(zoneList, zoneName)
    end

    table.sort(zoneList, function(a, b) return a < b end)

    while getgenv().EnableTeleport do
        for i, zoneName in ipairs(zoneList) do
            local target = getgenv().TargetPlayersPerZone[zoneName]
            local current = getPlayerCountInZone(zoneName)

            print(string.format("[%s] %d / %d", zoneName, current, target))

            if current < target then
                teleportTo(zoneName)
                break
            elseif current == target and zoneList[i + 1] then
                teleportTo(zoneList[i + 1])
                break
            end
        end

        -- Tạo party sau khi Teleport
        task.delay(3, function()
            if getgenv().EnableParty then
                for mode, isEnabled in pairs(getgenv().EnableParty) do
                    if isEnabled then createParty(mode) end
                end
            end
        end)

        task.wait(getgenv().TeleportInterval or 5)
    end
end)
